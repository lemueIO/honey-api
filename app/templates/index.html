<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="refresh" content="15"> Removed in favor of AJAX updates -->
    <title>Honey Cloud Intelligence</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png?v=2">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png?v=2">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png?v=2">
    <link rel="shortcut icon" href="/static/favicon.ico?v=2">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            box-shadow: none;
        }

        .card:hover {
            /* transform: translateY(-2px); Removed to avoid confusion with pulse animation */
            border-color: #8b949e;
        }

        .card-header {
            background-color: #161b22;
            border-bottom: 1px solid #30363d;
        }

        .stat-card {
            color: #fff;
        }

        /* Keep gradients but adjust opacity or overlay if needed, 
           or leave as is for contrast. */
        .bg-local {
            background: linear-gradient(135deg, #1f6feb, #238636);
        }

        .bg-osint {
            background: linear-gradient(135deg, #238636, #2ea043);
        }

        .bg-blacklist {
            background: linear-gradient(135deg, #da3633, #b62324);
        }

        .bg-whitelist {
            background: linear-gradient(135deg, #d29922, #9e6a03);
        }

        .btn-primary {
            background-color: #238636;
            border-color: #238636;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #2ea043;
            border-color: #2ea043;
        }

        .form-control,
        .form-select {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #0d1117;
            border-color: #58a6ff;
            color: #c9d1d9;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .table {
            color: #c9d1d9;
            border-color: #30363d;
        }

        .table-light {
            background-color: #161b22;
            color: #c9d1d9;
            border-bottom: 2px solid #30363d;
        }

        /* Fix for table header cells trying to be light */
        .table thead th {
            background-color: #161b22;
            color: #8b949e;
            border-color: #30363d;
        }

        .table-hover tbody tr:hover {
            background-color: #21262d;
            color: #c9d1d9;
        }

        /* Stats card text need to be readable on gradients - default is white which is fine */

        @keyframes pulse-animation {
            0% {
                transform: scale(1);
                border-color: #30363d;
            }

            50% {
                transform: scale(1.02);
                border-color: #ff4444;
                box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            }

            100% {
                transform: scale(1);
                border-color: #30363d;
            }
        }

        .pulse {
            animation: pulse-animation 2s ease-in-out;
            position: relative;
            z-index: 10;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4"
        style="background-color: #161b22 !important; border-bottom: 1px solid #30363d;">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="/static/logo_bear.png?v=5" alt="Logo" width="30" height="30"
                    class="d-inline-block align-text-top me-2" style="max-width: 100%; height: auto;">
                <i class="bi bi-shield-check"></i> Honey Cloud Intelligence
            </a>
            <div class="ms-auto">
                <a href="/logout" class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <!-- Stats Row -->
        <div class="row g-4 mb-5 text-center">
            <div class="col-md-3">
                <div class="card stat-card bg-local h-100">
                    <div class="card-body">
                        <h5 class="card-title">Honey Cloud Intelligence IPs</h5>
                        <p class="display-6 fw-bold mb-0" id="stats-local">{{ stats.local }}</p>
                        <small>Last 365 Days</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-osint h-100">
                    <div class="card-body">
                        <h5 class="card-title">OSINT IPs</h5>
                        <p class="display-6 fw-bold mb-0" id="stats-osint">{{ stats.osint }}</p>
                        <small>Last 90 Days</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-blacklist h-100">
                    <div class="card-body">
                        <h5 class="card-title">Scan-Blacklist</h5>
                        <div class="d-flex justify-content-center align-items-baseline gap-2 mb-1">
                            <span class="fs-4 fw-bold" id="stats-blacklist-networks">{{ stats.blacklist }}</span>
                            <small class="text-white-50">Rules</small>
                        </div>
                        <div class="d-flex justify-content-center align-items-baseline gap-2">
                            <span class="fs-4 fw-bold" id="stats-blacklist-ips-display">-</span>
                            <small class="text-white-50">IPs</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-whitelist h-100">
                    <div class="card-body">
                        <h5 class="card-title">Whitelist</h5>
                        <p class="display-6 fw-bold mb-0" id="stats-whitelist">{{ stats.whitelist }}</p>
                        <small>Permanent</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status Row -->
        <div class="row mb-5 text-center justify-content-center">
            <div class="col-md-6">
                <div class="card p-2" style="background-color: #0d1117; border: 1px solid #30363d;">
                    <div class="d-flex justify-content-around align-items-center text-muted small">
                        <div>
                            API Status:
                            <span id="api-status-dot"
                                style="height: 10px; width: 10px; background-color: grey; border-radius: 50%; display: inline-block; margin-left: 5px;"></span>
                            <span id="api-status-text">Checking...</span>
                            <small class="ms-2">
                                <a href="https://check-host.net/check-http?host=https://api.sec.lemue.org/"
                                    target="_blank" class="text-decoration-none text-muted">
                                    <i class="bi bi-box-arrow-up-right"></i> Check External
                                </a>
                            </small>
                        </div>
                        <div>
                            Last Cloud (24h): <span id="stats-last-cloud" class="fw-bold text-light">-</span> IPs
                        </div>
                        <div>
                            Last OSINT: <span id="stats-last-osint" class="fw-bold text-light">-</span> IPs
                        </div>
                        <div class="border-start ps-3">
                            <a href="/cloud" target="_blank" class="text-decoration-none text-light fw-bold">
                                <i class="bi bi-activity"></i> Global Cloud Status
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- API Key Management -->
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header py-3 border-0">
                        <h5 class="mb-0"><i class="bi bi-key-fill text-primary"></i> API Key Management</h5>
                    </div>
                    <div class="card-body">
                        <form action="/api-key/generate" method="post" class="row g-3 mb-4">
                            <div class="col-md-9">
                                <input type="text" name="name" class="form-control"
                                    placeholder="Key Name (e.g. HFish Node 1)" required>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i>
                                    Generate New Key</button>
                            </div>
                        </form>
                        <div class="table-responsive" style="max-height: none;">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Key</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key, name in api_keys.items() %}
                                    <tr>
                                        <td class="fw-bold">{{ name }}</td>
                                        <td>
                                            <div class="input-group">
                                                <code class="form-control border-0 py-2"
                                                    style="background-color: #21262d; color: #e1e4e8;">{{ key }}</code>
                                                <button class="btn btn-outline-secondary btn-sm border-0"
                                                    style="background-color: #21262d; color: #8b949e;" type="button"
                                                    onclick="copyToClipboard('{{ key }}', this)">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <form action="/api-key/delete" method="post"
                                                onsubmit="return confirm('WARNING: Are you sure you want to delete this API key? This action cannot be undone and will break any services using this key.');">
                                                <input type="hidden" name="key" value="{{ key }}">
                                                <button type="submit" class="btn btn-outline-danger btn-sm"><i
                                                        class="bi bi-trash"></i> Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% if not api_keys %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">No API keys generated</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Management -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header py-3 border-0">
                        <h5 class="mb-0"><i class="bi bi-list-stars text-primary"></i> List Management</h5>
                    </div>
                    <div class="card-body">
                        <form action="/list/add" method="post" class="row g-3 mb-4">
                            <div class="col-md-6">
                                <input type="text" name="ip" class="form-control"
                                    placeholder="IP Address (e.g. 1.2.3.4)" required>
                            </div>
                            <div class="col-md-3">
                                <select name="list_type" class="form-select">
                                    <option value="blacklist">Scan-Blacklist</option>
                                    <option value="whitelist">Whitelist</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i>
                                    Add Entry</button>
                            </div>
                        </form>

                        <div class="row g-4">
                            <!-- Blacklist Display -->
                            <div class="col-md-6">
                                <div class="p-3 border rounded bg-opacity-10"
                                    style="background-color: #0d1117; border-color: #30363d !important;">
                                    <h6 class="fw-bold mb-3 d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-shield-slash text-danger"></i> Scan-Blacklist
                                            (Discarded)</span>
                                        <span class="badge bg-danger rounded-pill" id="badge-blacklist">{{
                                            stats.blacklist }}</span>
                                    </h6>
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>IP</th>
                                                    <th class="text-end">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ip in blacklist %}
                                                <tr>
                                                    <td class="font-monospace">{{ ip }}</td>
                                                    <td class="text-end">
                                                        <form action="/list/remove" method="post" class="d-inline"
                                                            onsubmit="return confirm('Remove {{ ip }} from blacklist?');">
                                                            <input type="hidden" name="ip" value="{{ ip }}">
                                                            <input type="hidden" name="list_type" value="blacklist">
                                                            <button type="submit"
                                                                class="btn btn-link text-danger p-0"><i
                                                                    class="bi bi-trash"></i></button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% if not blacklist %}
                                                <tr>
                                                    <td colspan="2" class="text-center text-muted py-3">Empty</td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <!-- Whitelist Display -->
                            <div class="col-md-6">
                                <div class="p-3 border rounded bg-opacity-10"
                                    style="background-color: #0d1117; border-color: #30363d !important;">
                                    <h6 class="fw-bold mb-3 d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-shield-check text-success"></i> Permanent Whitelist</span>
                                        <span class="badge bg-success rounded-pill" id="badge-whitelist">{{
                                            stats.whitelist }}</span>
                                    </h6>
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>IP</th>
                                                    <th class="text-end">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for ip in whitelist %}
                                                <tr>
                                                    <td class="font-monospace">{{ ip }}</td>
                                                    <td class="text-end">
                                                        <form action="/list/remove" method="post" class="d-inline"
                                                            onsubmit="return confirm('Remove {{ ip }} from whitelist?');">
                                                            <input type="hidden" name="ip" value="{{ ip }}">
                                                            <input type="hidden" name="list_type" value="whitelist">
                                                            <button type="submit"
                                                                class="btn btn-link text-danger p-0"><i
                                                                    class="bi bi-trash"></i></button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% if not whitelist %}
                                                <tr>
                                                    <td colspan="2" class="text-center text-muted py-3">Empty</td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Ban / Forced Reporting -->
                <div class="card mt-4">
                    <div class="card-header py-3 border-0">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill text-danger"></i> Manual IP Ban &
                            Reporting</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-4">
                            Use this function to manually inject an IP into the Honey Cloud Intelligence database.
                            The IP will be treated as a fresh attack, triggering any external notifications or
                            processing.
                        </p>
                        <form action="/api/ban" method="post" class="row g-3">
                            <div class="col-md-9">
                                <input type="text" name="ip" class="form-control"
                                    placeholder="IP Address to ban and report (e.g. 8.8.8.8)" required>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="bi bi-megaphone-fill"></i> Ban & Report IP
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyToClipboard(text, btn) {
            const onSuccess = () => {
                const icon = btn.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'bi bi-check2 text-success';
                setTimeout(() => {
                    icon.className = originalClass;
                }, 2000);
            };

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(onSuccess).catch(err => {
                    console.error('Clipboard error:', err);
                    fallbackCopy(text, onSuccess);
                });
            } else {
                fallbackCopy(text, onSuccess);
            }
        }

        function fallbackCopy(text, callback) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                callback();
            } catch (err) {
                console.error('Fallback copy error:', err);
            }
            document.body.removeChild(textArea);
        }

        // Stats Refresh Logic. Keep track of previous values to animate only on change.
        const previousStats = {
            local: null,
            osint: null,
            blacklist: null,
            whitelist: null
        };

        function animateElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // Find the closest card parent to animate the whole card, or just the number?
                // User asked for "the box", so let's animate the card.
                const card = element.closest('.card');
                if (card) {
                    card.classList.remove('pulse');
                    void card.offsetWidth; // trigger reflow
                    card.classList.add('pulse');
                }
            }
        }

        // Formatter for "5 stellige Darstellung" (4 significant digits + dot)
        function formatRecount(value) {
            if (value === undefined || value === null) return '-';
            if (value === 0) return '0';

            const tiers = [
                { val: 1e24, suffix: ' Y' },
                { val: 1e21, suffix: ' Z' },
                { val: 1e18, suffix: ' E' },
                { val: 1e15, suffix: ' P' },
                { val: 1e12, suffix: ' T' },
                { val: 1e9, suffix: ' B' },
                { val: 1e6, suffix: ' M' },
                { val: 1e3, suffix: ' k' }
            ];

            for (const tier of tiers) {
                if (value >= tier.val) {
                    const num = value / tier.val;
                    return num.toPrecision(4) + tier.suffix;
                }
            }
            return value.toString();
        }

        function updateStats() {
            fetch('/api/stats')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.reload(); // Reload if session expired
                        }
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update Main Stats Cards
                    const updateField = (id, key) => {
                        const el = document.getElementById(id);
                        if (el) {
                            const newValue = data[key];
                            // Only animate if we have a previous value and it changed
                            if (previousStats[key] !== null && previousStats[key] !== newValue) {
                                animateElement(id);
                            }
                            el.innerText = newValue;
                            previousStats[key] = newValue;
                        }
                    };

                    updateField('stats-local', 'local');
                    updateField('stats-osint', 'osint');
                    updateField('stats-local', 'local');
                    updateField('stats-osint', 'osint');

                    // Update Blacklist Rules Count
                    const blRulesEl = document.getElementById('stats-blacklist-networks');
                    if (blRulesEl && data.blacklist !== undefined) {
                        const val = data.blacklist;
                        if (previousStats['blacklist'] !== val) {
                            previousStats['blacklist'] = val;
                        }
                        blRulesEl.innerText = formatRecount(val);
                    }

                    // Special formatting for Blacklist IPs
                    const blEl = document.getElementById('stats-blacklist-ips-display');
                    if (blEl && data.blacklist_ips !== undefined) {
                        const val = data.blacklist_ips;
                        if (previousStats['blacklist_ips'] !== val) {
                            animateElement('stats-blacklist-ips-display');
                            previousStats['blacklist_ips'] = val;
                        }
                        blEl.innerText = formatRecount(val);
                    }
                    updateField('stats-whitelist', 'whitelist');
                    updateField('stats-whitelist', 'whitelist');

                    // Update List Badges
                    const badgeBlacklist = document.getElementById('badge-blacklist');
                    const badgeWhitelist = document.getElementById('badge-whitelist');

                    if (badgeBlacklist) badgeBlacklist.innerText = data.blacklist;
                    if (badgeWhitelist) badgeWhitelist.innerText = data.whitelist;

                    // Update System Status
                    const apiDot = document.getElementById('api-status-dot');
                    const apiText = document.getElementById('api-status-text');
                    const lastCloud = document.getElementById('stats-last-cloud');
                    const lastOsint = document.getElementById('stats-last-osint');

                    if (apiDot && apiText) {
                        if (data.api_up) {
                            apiDot.style.backgroundColor = '#238636'; // Green
                            apiText.innerText = 'Online';
                            apiText.style.color = '#238636';
                        } else {
                            apiDot.style.backgroundColor = '#da3633'; // Red
                            apiText.innerText = 'Offline';
                            apiText.style.color = '#da3633';
                        }
                    }

                    if (lastCloud) {
                        const val = data.last_cloud_count || 0;
                        const sign = val >= 0 ? '+' : '';
                        lastCloud.innerText = `${sign}${val}`;
                    }
                    if (lastOsint) {
                        const val = data.last_osint_count || 0;
                        const sign = val >= 0 ? '+' : '';
                        lastOsint.innerText = `${sign}${val}`;
                    }
                })
                .catch(error => console.error('Error fetching stats:', error));
        }

        // Initialize previousStats from DOM to ensure first real update triggers animation
        document.addEventListener('DOMContentLoaded', () => {
            const initVal = (id, key) => {
                const el = document.getElementById(id);
                if (el) {
                    // remove commas if present and parse
                    const val = parseInt(el.innerText.replace(/,/g, ''));
                    previousStats[key] = isNaN(val) ? 0 : val;
                }
            };
            initVal('stats-local', 'local');
            initVal('stats-osint', 'osint');
            // initVal('stats-blacklist', 'blacklist');
            // initVal('stats-blacklist-ips', 'blacklist_ips');
            // Manual init for display
            const blEl = document.getElementById('stats-blacklist-ips-display');
            if (blEl) previousStats['blacklist_ips'] = 0; // Force update on first load
            initVal('stats-whitelist', 'whitelist');
            initVal('stats-whitelist', 'whitelist');
        });

        // Poll every 10 seconds
        setInterval(updateStats, 10000);
    </script>
</body>

</html>